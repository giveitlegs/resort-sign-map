<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resort Sign Inventory Map</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f5f5f5;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #0052A5 0%, #003d7a 100%);
            color: white;
            padding: 16px 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            position: relative;
            z-index: 1000;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .header-subtitle {
            font-size: 14px;
            opacity: 0.85;
        }

        .header-logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-logo img {
            height: 40px;
        }

        /* Main Layout */
        .main-container {
            display: flex;
            height: calc(100vh - 80px);
        }

        /* Sidebar */
        .sidebar {
            width: 340px;
            background: white;
            box-shadow: 2px 0 8px rgba(0,0,0,0.1);
            overflow-y: auto;
            z-index: 999;
        }

        .sidebar-section {
            padding: 16px;
            border-bottom: 1px solid #e5e5e5;
        }

        .sidebar-section h3 {
            font-size: 13px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        /* Filters */
        .filter-group {
            margin-bottom: 16px;
        }

        .filter-group label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: #333;
            margin-bottom: 6px;
        }

        .filter-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .filter-select:hover {
            border-color: #0052A5;
        }

        .filter-select:focus {
            outline: none;
            border-color: #0052A5;
            box-shadow: 0 0 0 3px rgba(0,82,165,0.1);
        }

        /* Sign Type/Material Checkboxes */
        .filter-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .filter-item {
            display: flex;
            align-items: center;
            padding: 6px 0;
            cursor: pointer;
            transition: background 0.2s;
            border-radius: 4px;
        }

        .filter-item:hover {
            background: #f5f5f5;
        }

        .filter-checkbox {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            cursor: pointer;
        }

        .filter-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 6px;
            flex-shrink: 0;
        }

        .filter-label {
            font-size: 12px;
            color: #333;
            flex: 1;
        }

        .filter-count {
            font-size: 11px;
            color: #999;
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 10px;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #0052A5;
        }

        .stat-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            margin-top: 4px;
        }

        /* Map */
        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* Custom Marker Popup */
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .leaflet-popup-content {
            margin: 0;
            min-width: 280px;
        }

        .popup-content {
            padding: 16px;
        }

        .popup-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #eee;
        }

        .popup-sign-id {
            font-size: 18px;
            font-weight: 700;
            color: #0052A5;
        }

        .popup-sign-type {
            font-size: 10px;
            padding: 3px 6px;
            background: #e8f4fc;
            color: #0052A5;
            border-radius: 4px;
            font-weight: 500;
        }

        .popup-resort {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .popup-type-material {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }

        .popup-location {
            font-size: 13px;
            color: #666;
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .popup-details {
            font-size: 12px;
            color: #888;
        }

        .popup-details div {
            margin-bottom: 4px;
        }

        .popup-image {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .popup-links {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #eee;
        }

        .popup-link {
            flex: 1;
            text-align: center;
            padding: 8px;
            background: #0052A5;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .popup-link:hover {
            background: #003d7a;
        }

        .popup-link.secondary {
            background: #f0f0f0;
            color: #333;
        }

        .popup-link.secondary:hover {
            background: #e0e0e0;
        }

        /* Legend */
        .legend {
            position: absolute;
            bottom: 24px;
            right: 24px;
            background: white;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
            min-width: 180px;
        }

        .legend h4 {
            font-size: 13px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            padding: 4px 0;
            font-size: 12px;
            color: #666;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            flex-shrink: 0;
        }

        /* Loading State */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #e5e5e5;
            border-top-color: #0052A5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 16px;
            font-size: 14px;
            color: #666;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                max-height: 40vh;
            }

            .legend {
                bottom: 12px;
                right: 12px;
                max-height: 200px;
            }
        }

        /* Select All / None buttons */
        .filter-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }

        .filter-btn {
            flex: 1;
            padding: 5px 10px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            border-color: #0052A5;
            color: #0052A5;
        }

        /* Collapsible sections */
        .section-toggle {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-toggle::after {
            content: '\25BC';
            font-size: 10px;
            transition: transform 0.2s;
        }

        .section-toggle.collapsed::after {
            transform: rotate(-90deg);
        }

        .section-content.collapsed {
            display: none;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-logo">
            <div>
                <h1>Resort Sign Inventory</h1>
                <div class="header-subtitle">Interactive Map Visualization</div>
            </div>
        </div>
    </header>

    <div class="main-container">
        <aside class="sidebar">
            <!-- Stats Section -->
            <div class="sidebar-section">
                <h3>Overview</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="total-signs">-</div>
                        <div class="stat-label">Total Signs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="total-resorts">-</div>
                        <div class="stat-label">Resorts</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="visible-signs">-</div>
                        <div class="stat-label">Visible</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="sign-types-count">-</div>
                        <div class="stat-label">Sign Types</div>
                    </div>
                </div>
            </div>

            <!-- Resort Filter -->
            <div class="sidebar-section">
                <h3>Filter by Resort</h3>
                <div class="filter-group">
                    <select id="resort-filter" class="filter-select">
                        <option value="all">All Resorts</option>
                    </select>
                </div>
            </div>

            <!-- Sign Type Filter -->
            <div class="sidebar-section">
                <h3 class="section-toggle" onclick="toggleSection('type')">Filter by Sign Type</h3>
                <div class="section-content" id="type-section">
                    <div class="filter-actions">
                        <button class="filter-btn" onclick="selectAllFilters('type')">All</button>
                        <button class="filter-btn" onclick="selectNoneFilters('type')">None</button>
                    </div>
                    <div class="filter-list" id="sign-type-filters">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Sign Material Filter -->
            <div class="sidebar-section">
                <h3 class="section-toggle" onclick="toggleSection('material')">Filter by Material</h3>
                <div class="section-content" id="material-section">
                    <div class="filter-actions">
                        <button class="filter-btn" onclick="selectAllFilters('material')">All</button>
                        <button class="filter-btn" onclick="selectNoneFilters('material')">None</button>
                    </div>
                    <div class="filter-list" id="sign-material-filters">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>
        </aside>

        <main class="map-container">
            <div id="map"></div>

            <!-- Legend -->
            <div class="legend" id="legend">
                <h4>Sign Types</h4>
                <div id="legend-items">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <!-- Loading Overlay -->
            <div class="loading-overlay" id="loading">
                <div style="text-align: center;">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">Loading sign data...</div>
                </div>
            </div>
        </main>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Papa Parse for CSV parsing -->
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

    <script>
        // Configuration
        const CONFIG = {
            // Google Sheets published CSV URL
            SHEET_CSV_URL: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTWA73Tdab9WvKURDT73rzG2FtauxsDUGfV_7pGskBE41zlgLfOy-TsTNHII7PPssxfAx-lCZj8pgS-/pub?output=csv&gid=0',

            // Default map center (Orlando, FL area)
            DEFAULT_CENTER: [28.4, -81.5],
            DEFAULT_ZOOM: 8,

            // Refresh interval (5 minutes)
            REFRESH_INTERVAL: 300000
        };

        // Resort coordinates for centering map when selected
        const RESORT_COORDINATES = {
            'Westgate Lakes Resort & Spa': { lat: 28.4375, lng: -81.4847 },
            'Westgate Town Center Resort': { lat: 28.3389, lng: -81.5986 },
            'Westgate Vacation Villas Resort': { lat: 28.3453, lng: -81.6019 },
            'Westgate Palace': { lat: 28.4461, lng: -81.4722 },
            'Westgate Towers Resort': { lat: 28.4356, lng: -81.4703 },
            'Westgate Blue Tree Resort': { lat: 28.3747, lng: -81.5092 },
            'Westgate Leisure Resort': { lat: 28.3892, lng: -81.4953 },
            'Westgate Cocoa Beach Resort': { lat: 28.3697, lng: -80.6061 },
            'Westgate River Ranch Resort & Rodeo': { lat: 27.7894, lng: -81.1533 },
            'Westgate Smoky Mountain Resort & Water Park': { lat: 35.7103, lng: -83.5192 },
            'River Terrace Resort & Convention Center': { lat: 35.7144, lng: -83.5156 },
            'Wild Bear Inn': { lat: 35.7939, lng: -83.5542 },
            'Westgate Branson Woods Resort': { lat: 36.6661, lng: -93.2847 },
            'Westgate Branson Lakes Resort': { lat: 36.5972, lng: -93.2308 },
            'Westgate Las Vegas Resort & Casino': { lat: 36.1281, lng: -115.1525 },
            'Westgate Flamingo Bay Resort': { lat: 36.1150, lng: -115.2028 },
            'Tahoe Trail': { lat: 38.9536, lng: -119.9425 },
            'Kingsbury of Tahoe': { lat: 38.9561, lng: -119.9439 },
            'Westgate Myrtle Beach Oceanfront Resort': { lat: 33.6897, lng: -78.8867 },
            'Westgate Park City Resort & Spa': { lat: 40.6844, lng: -111.5228 },
            'Westgate Historic Williamsburg Resort': { lat: 37.2761, lng: -76.7556 },
            'Westgate Painted Mountain Golf Resort': { lat: 33.4556, lng: -111.7369 },
            'The Village at Steamboat': { lat: 40.4697, lng: -106.8106 },
            'The Oasis': { lat: 33.7881, lng: -116.4928 },
            'Westgate New York Grand Central': { lat: 40.7506, lng: -73.9736 },
            'The Pines at Sunriver': { lat: 43.8756, lng: -121.4378 },
            'VI at Homestead': { lat: 48.9469, lng: -122.4458 },
            'Royal Kuhio': { lat: 21.2769, lng: -157.8250 },
            'Sea Mountain': { lat: 19.2008, lng: -155.4347 },
            'Sea Village': { lat: 19.5800, lng: -155.9714 },
            'VI at Rosedale on Robson': { lat: 49.2781, lng: -123.1186 },
            'Pinnacle Lodge': { lat: 50.8833, lng: -119.9000 },
            'Torres Mazatlan': { lat: 23.2494, lng: -106.4492 }
        };

        // Sign type colors - vibrant, distinct colors
        const SIGN_TYPE_COLORS = {
            'Wayfinding / Directional': '#1E90FF',
            'Building Identification': '#4682B4',
            'Parking / Traffic': '#2F4F4F',
            'Exit / Entrance': '#228B22',
            'Regulatory / Compliance': '#B22222',
            'Pool Rules': '#20B2AA',
            'Safety / Warning': '#FF4500',
            'ADA / Accessibility': '#6A5ACD',
            'Fire Safety': '#DC143C',
            'Room / Unit Number': '#CD853F',
            'Floor Directory': '#708090',
            'Amenity Identification': '#32CD32',
            'Hours of Operation': '#4169E1',
            'Menu Board': '#8FBC8F',
            'Welcome / Greeting': '#FFD700',
            'Promotional / Marketing': '#FF69B4',
            'Event / Announcement': '#FF8C00',
            'Monument Sign': '#8B4513',
            'Channel Letters': '#FFD700',
            'Pylon / Pole Sign': '#4682B4',
            'Marquee Sign': '#DC143C',
            'A-Frame / Sandwich Board': '#FF8C00',
            'Banner': '#FF69B4',
            'Construction / Temporary': '#808080',
            'Other': '#808080'
        };

        // Sign material colors
        const SIGN_MATERIAL_COLORS = {
            'Aluminum Composite (Dibond)': '#A9A9A9',
            'Aluminum (Solid)': '#708090',
            'Acrylic': '#00CED1',
            'PVC / Sintra': '#4169E1',
            'HDU (High-Density Urethane)': '#9370DB',
            'Gatorboard / Foamboard': '#32CD32',
            'Coroplast (Corrugated Plastic)': '#FF6347',
            'Sandblasted Wood': '#8B4513',
            'Painted Wood': '#A0522D',
            'Routed Wood': '#D2691E',
            'Stainless Steel': '#C0C0C0',
            'Brushed Aluminum': '#B0C4DE',
            'Brass / Bronze': '#B8860B',
            'Corten Steel (Rusted)': '#8B4513',
            'Vinyl Banner': '#FF69B4',
            'Fabric / Mesh Banner': '#DDA0DD',
            'Magnetic': '#4682B4',
            'LED / Illuminated': '#00FF7F',
            'Neon': '#FF00FF',
            'Digital Display': '#00CED1',
            'Etched Glass': '#E0FFFF',
            'Cast Bronze / Aluminum': '#CD7F32',
            'Stone / Granite': '#696969',
            'Concrete': '#808080',
            'Other / Unknown': '#808080'
        };

        // Default color for unknown types
        const DEFAULT_COLOR = '#0052A5';

        // Global state
        let map;
        let markers = [];
        let allSignData = [];
        let signTypeFilters = {};
        let signMaterialFilters = {};

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            loadSignData();

            // Auto-refresh
            setInterval(loadSignData, CONFIG.REFRESH_INTERVAL);
        });

        // Initialize Leaflet map
        function initMap() {
            map = L.map('map').setView(CONFIG.DEFAULT_CENTER, CONFIG.DEFAULT_ZOOM);

            // Add OpenStreetMap tiles (free, no API key needed)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            }).addTo(map);
        }

        // Load sign data from Google Sheets
        async function loadSignData() {
            try {
                showLoading(true);

                const response = await fetch(CONFIG.SHEET_CSV_URL);
                const csvText = await response.text();

                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        // Map column names from Google Sheet to expected names
                        allSignData = results.data
                            .map(row => ({
                                signId: row['Global Unique ID'],
                                entryId: row['Unique String'],
                                timestamp: row['Date and timestamp'],
                                resortName: row['Property'],
                                signType: row['Sign Type'],
                                signMaterial: row['Sign Material'] || row['Material'] || '',
                                locationDescription: row['Description of Location'],
                                latitude: row['Latitude'],
                                longitude: row['Longitude'],
                                accuracy: row['Margin of Error in Meters'],
                                marketingManager: row['Marketing Manager'],
                                contactName: row['Engineering Contact Name'],
                                contactEmail: row['Engineering Contact Email'],
                                contactPhone: row['Engineering Contact Phone'],
                                wasRecentlyInstalled: row['Is this Sign Being Re-Installed'],
                                lastInstallDate: row['Date and Timestamp of Re-Install'],
                                photoUrls: row['Google Drive Link'],
                                gammaSlideUrl: row['Google Slide Link'],
                                uploadStatus: row['Status']
                            }))
                            .filter(row =>
                                row.latitude && row.longitude &&
                                !isNaN(parseFloat(row.latitude)) &&
                                !isNaN(parseFloat(row.longitude))
                            );

                        populateFilters();
                        updateMap();
                        updateStats();
                        showLoading(false);
                    },
                    error: function(error) {
                        console.error('Error parsing CSV:', error);
                        showLoading(false);
                        alert('Error loading sign data. Make sure the Google Sheet is published to the web.');
                    }
                });
            } catch (error) {
                console.error('Error fetching data:', error);
                showLoading(false);
                alert('Error loading sign data. Check console for details.');
            }
        }

        // Populate filter dropdowns and checkboxes
        function populateFilters() {
            // Get unique resorts
            const resorts = [...new Set(allSignData.map(s => s.resortName))].filter(r => r).sort();
            const resortSelect = document.getElementById('resort-filter');
            resortSelect.innerHTML = '<option value="all">All Resorts</option>';
            resorts.forEach(resort => {
                const option = document.createElement('option');
                option.value = resort;
                option.textContent = resort;
                resortSelect.appendChild(option);
            });

            // Get unique sign types with counts
            const signTypeCounts = {};
            allSignData.forEach(s => {
                const type = s.signType || 'Other';
                signTypeCounts[type] = (signTypeCounts[type] || 0) + 1;
            });

            // Get unique sign materials with counts
            const signMaterialCounts = {};
            allSignData.forEach(s => {
                const material = s.signMaterial || 'Other / Unknown';
                signMaterialCounts[material] = (signMaterialCounts[material] || 0) + 1;
            });

            // Populate sign type filters
            const signTypes = Object.keys(signTypeCounts).sort();
            const signTypeContainer = document.getElementById('sign-type-filters');
            const legendContainer = document.getElementById('legend-items');

            signTypeContainer.innerHTML = '';
            legendContainer.innerHTML = '';

            signTypes.forEach(type => {
                const color = getSignTypeColor(type);

                // Initialize filter state (all checked by default)
                if (signTypeFilters[type] === undefined) {
                    signTypeFilters[type] = true;
                }

                // Sidebar checkbox
                const item = document.createElement('div');
                item.className = 'filter-item';
                item.innerHTML = `
                    <input type="checkbox" class="filter-checkbox type-checkbox"
                           data-type="${type}"
                           ${signTypeFilters[type] ? 'checked' : ''}
                           onchange="toggleFilter('type', '${type.replace(/'/g, "\\'")}', this.checked)">
                    <div class="filter-color" style="background: ${color}"></div>
                    <span class="filter-label">${type}</span>
                    <span class="filter-count">${signTypeCounts[type]}</span>
                `;
                signTypeContainer.appendChild(item);

                // Legend item
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                legendItem.innerHTML = `
                    <div class="legend-color" style="background: ${color}"></div>
                    <span>${type}</span>
                `;
                legendContainer.appendChild(legendItem);
            });

            // Populate sign material filters
            const signMaterials = Object.keys(signMaterialCounts).sort();
            const signMaterialContainer = document.getElementById('sign-material-filters');
            signMaterialContainer.innerHTML = '';

            signMaterials.forEach(material => {
                const color = getMaterialColor(material);

                // Initialize filter state (all checked by default)
                if (signMaterialFilters[material] === undefined) {
                    signMaterialFilters[material] = true;
                }

                // Sidebar checkbox
                const item = document.createElement('div');
                item.className = 'filter-item';
                item.innerHTML = `
                    <input type="checkbox" class="filter-checkbox material-checkbox"
                           data-material="${material}"
                           ${signMaterialFilters[material] ? 'checked' : ''}
                           onchange="toggleFilter('material', '${material.replace(/'/g, "\\'")}', this.checked)">
                    <div class="filter-color" style="background: ${color}"></div>
                    <span class="filter-label">${material}</span>
                    <span class="filter-count">${signMaterialCounts[material]}</span>
                `;
                signMaterialContainer.appendChild(item);
            });

            // Add event listener for resort filter
            resortSelect.addEventListener('change', onResortChange);
        }

        // Handle resort filter change - center map on selected resort
        function onResortChange() {
            const selectedResort = document.getElementById('resort-filter').value;

            if (selectedResort !== 'all') {
                // Try to get coordinates from our lookup table
                const coords = RESORT_COORDINATES[selectedResort];
                if (coords) {
                    map.setView([coords.lat, coords.lng], 15);
                } else {
                    // Fall back to centering on signs at this resort
                    const resortSigns = allSignData.filter(s => s.resortName === selectedResort);
                    if (resortSigns.length > 0) {
                        const avgLat = resortSigns.reduce((sum, s) => sum + parseFloat(s.latitude), 0) / resortSigns.length;
                        const avgLng = resortSigns.reduce((sum, s) => sum + parseFloat(s.longitude), 0) / resortSigns.length;
                        map.setView([avgLat, avgLng], 15);
                    }
                }
            }

            updateMap();
        }

        // Get color for sign type
        function getSignTypeColor(signType) {
            return SIGN_TYPE_COLORS[signType] || DEFAULT_COLOR;
        }

        // Get color for sign material
        function getMaterialColor(material) {
            return SIGN_MATERIAL_COLORS[material] || DEFAULT_COLOR;
        }

        // Toggle filter
        function toggleFilter(filterType, value, checked) {
            if (filterType === 'type') {
                signTypeFilters[value] = checked;
            } else {
                signMaterialFilters[value] = checked;
            }
            updateMap();
        }

        // Select all filters
        function selectAllFilters(filterType) {
            if (filterType === 'type') {
                Object.keys(signTypeFilters).forEach(type => {
                    signTypeFilters[type] = true;
                });
                document.querySelectorAll('.type-checkbox').forEach(cb => cb.checked = true);
            } else {
                Object.keys(signMaterialFilters).forEach(material => {
                    signMaterialFilters[material] = true;
                });
                document.querySelectorAll('.material-checkbox').forEach(cb => cb.checked = true);
            }
            updateMap();
        }

        // Select no filters
        function selectNoneFilters(filterType) {
            if (filterType === 'type') {
                Object.keys(signTypeFilters).forEach(type => {
                    signTypeFilters[type] = false;
                });
                document.querySelectorAll('.type-checkbox').forEach(cb => cb.checked = false);
            } else {
                Object.keys(signMaterialFilters).forEach(material => {
                    signMaterialFilters[material] = false;
                });
                document.querySelectorAll('.material-checkbox').forEach(cb => cb.checked = false);
            }
            updateMap();
        }

        // Toggle section collapse
        function toggleSection(sectionId) {
            const toggle = event.target;
            const content = document.getElementById(sectionId + '-section');
            toggle.classList.toggle('collapsed');
            content.classList.toggle('collapsed');
        }

        // Update map markers
        function updateMap() {
            // Clear existing markers
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            // Get filter values
            const selectedResort = document.getElementById('resort-filter').value;

            // Filter data
            const filteredData = allSignData.filter(sign => {
                // Resort filter
                if (selectedResort !== 'all' && sign.resortName !== selectedResort) {
                    return false;
                }

                // Sign type filter
                const signType = sign.signType || 'Other';
                if (!signTypeFilters[signType]) {
                    return false;
                }

                // Sign material filter
                const signMaterial = sign.signMaterial || 'Other / Unknown';
                if (!signMaterialFilters[signMaterial]) {
                    return false;
                }

                return true;
            });

            // Add markers
            const bounds = [];

            filteredData.forEach(sign => {
                const lat = parseFloat(sign.latitude);
                const lng = parseFloat(sign.longitude);

                if (isNaN(lat) || isNaN(lng)) return;

                const color = getSignTypeColor(sign.signType || 'Other');

                // Create custom icon
                const icon = L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="
                        width: 24px;
                        height: 24px;
                        background: ${color};
                        border: 3px solid white;
                        border-radius: 50%;
                        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                    "></div>`,
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                });

                const marker = L.marker([lat, lng], { icon: icon });

                // Create popup content
                const popupContent = createPopupContent(sign);
                marker.bindPopup(popupContent, {
                    maxWidth: 320,
                    className: 'custom-popup'
                });

                // Show popup on hover
                marker.on('mouseover', function() {
                    this.openPopup();
                });

                marker.addTo(map);
                markers.push(marker);
                bounds.push([lat, lng]);
            });

            // Fit map to markers only if showing all resorts
            if (selectedResort === 'all' && bounds.length > 0) {
                map.fitBounds(bounds, { padding: [50, 50] });
            }

            // Update visible count
            document.getElementById('visible-signs').textContent = filteredData.length;
        }

        // Create popup content for a sign
        function createPopupContent(sign) {
            const imageHtml = sign.photoUrls ?
                `<img src="${sign.photoUrls.split(',')[0]}" class="popup-image" onerror="this.style.display='none'" alt="Sign photo">` : '';

            const slideLink = sign.gammaSlideUrl ?
                `<a href="${sign.gammaSlideUrl}" target="_blank" class="popup-link">View Slide</a>` : '';

            const mapsLink = `<a href="https://www.google.com/maps?q=${sign.latitude},${sign.longitude}" target="_blank" class="popup-link secondary">Open in Maps</a>`;

            const materialInfo = sign.signMaterial ? `<strong>Material:</strong> ${sign.signMaterial}` : '';

            return `
                <div class="popup-content">
                    ${imageHtml}
                    <div class="popup-header">
                        <span class="popup-sign-id">${sign.signId || 'N/A'}</span>
                        <span class="popup-sign-type">${sign.signType || 'Unknown'}</span>
                    </div>
                    <div class="popup-resort">${sign.resortName || 'Unknown Resort'}</div>
                    ${sign.signMaterial ? `<div class="popup-type-material">${sign.signMaterial}</div>` : ''}
                    <div class="popup-location">${sign.locationDescription || 'No description'}</div>
                    <div class="popup-details">
                        <div><strong>GPS:</strong> ${parseFloat(sign.latitude).toFixed(6)}, ${parseFloat(sign.longitude).toFixed(6)}</div>
                        <div><strong>Accuracy:</strong> +/-${sign.accuracy || '?'}m</div>
                        <div><strong>Captured:</strong> ${sign.timestamp || 'Unknown'}</div>
                        ${sign.marketingManager ? `<div><strong>Marketing:</strong> ${sign.marketingManager}</div>` : ''}
                        ${sign.contactName ? `<div><strong>Contact:</strong> ${sign.contactName}</div>` : ''}
                    </div>
                    <div class="popup-links">
                        ${slideLink}
                        ${mapsLink}
                    </div>
                </div>
            `;
        }

        // Update statistics
        function updateStats() {
            const totalSigns = allSignData.length;
            const resorts = new Set(allSignData.map(s => s.resortName)).size;
            const signTypes = new Set(allSignData.map(s => s.signType)).size;

            document.getElementById('total-signs').textContent = totalSigns;
            document.getElementById('total-resorts').textContent = resorts;
            document.getElementById('visible-signs').textContent = totalSigns;
            document.getElementById('sign-types-count').textContent = signTypes;
        }

        // Show/hide loading overlay
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'flex' : 'none';
        }
    </script>
</body>
</html>
